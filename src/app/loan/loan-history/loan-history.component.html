<p-toast></p-toast>

<div class="history-wrapper">
  <div class="history-header">
    <div class="header-content">
      <h1>Lịch sử thanh toán khoản vay</h1>
      <p class="subtitle">Theo dõi chi tiết các khoản thanh toán của bạn</p>
    </div>
  </div>

  <div class="main-panel">
    <div class="history-container">
      <!-- Stats Section -->
      <div class="stats-section">
        <div class="stats-grid">
          <p-card class="stat-card total-paid">
            <div class="stat-content">
              <div class="stat-icon">
                <i class="pi pi-check-circle"></i>
              </div>
              <div class="stat-info">
                <h3>Tổng số tiền đã trả</h3>
                <p class="stat-value">{{ calculateTotalPaid() | currency:'VND':'symbol':'1.0-0' }}</p>
              </div>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="filter-content">
          <span class="p-input-icon-right">
            <i class="pi pi-calendar"></i>
            <p-calendar
              [(ngModel)]="dateRange"
              selectionMode="range"
              [showButtonBar]="true"
              [readonlyInput]="true"
              placeholder="Chọn khoảng thời gian"
              styleClass="w-full md:w-25rem"
            ></p-calendar>
          </span>
          <div class="filter-buttons">
            <p-button
              label="Áp dụng bộ lọc"
              icon="pi pi-filter"
              (onClick)="applyDateFilter()"
              [disabled]="!dateRange || dateRange.length !== 2"
              styleClass="p-button-raised modern-button primary-btn">
            </p-button>
            <p-button
              label="Xóa bộ lọc"
              icon="pi pi-times"
              severity="secondary"
              (onClick)="clearDateFilter()"
              [disabled]="!dateRange || dateRange.length === 0"
              styleClass="p-button-raised modern-button secondary-btn">
            </p-button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-overlay" *ngIf="loading">
        <p-progressSpinner strokeWidth="6"></p-progressSpinner>
      </div>

      <!-- Error State -->
      <div class="error-banner" *ngIf="!loading && error">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>

      <!-- Repayment History Table -->
      <div class="table-section" *ngIf="!loading && !error">
        <p-table
          [value]="filteredRepayments"
          styleClass="p-datatable-gridlines modern-table"
          [expandedRowKeys]="expandedRows"
          [rowHover]="true"
          dataKey="repaymentId"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 3rem"></th>
              <th>Mã thanh toán</th>
              <th>Ngày đến hạn</th>
              <th>Trạng thái</th>
              <th>Tổng số tiền</th>
              <th>Số tiền đã trả</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-repayment>
            <tr>
              <td>
                <button
                  type="button"
                  pButton
                  pRipple
                  [pRowToggler]="repayment"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="expandedRows[repayment.repaymentId] ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                ></button>
              </td>
              <td>{{ repayment.repaymentId }}</td>
              <td>{{ repayment.dueDate | date:'mediumDate' }}</td>
              <td>
                <span
                  pBadge="New" 
                  severity="success"
                  styleClass="p-badge-sm"
                ></span>
              </td>
              <td>{{ calculateTotalAmount(repayment) | currency:'VND':'symbol-narrow':'1.0-0' }}</td>
              <td>{{ repayment.paidAmount | currency:'VND':'symbol-narrow':'1.0-0' }}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="rowexpansion" let-repayment>
            <tr>
              <td colspan="6">
                <div class="expansion-content">
                  <div class="grid">
                    <div class="col-12 md:col-6">
                      <div class="detail-grid">
                        <div class="detail-item">
                          <span class="detail-label">Số tiền gốc:</span>
                          <span class="detail-value">{{ repayment.principal | currency:'VND':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Số tiền lãi:</span>
                          <span class="detail-value">{{ repayment.interest | currency:'VND':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Số tiền còn lại:</span>
                          <span class="detail-value">{{ calculateRemainingAmount(repayment) | currency:'VND':'symbol-narrow':'1.0-0' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center p-4">
                Không tìm thấy lịch sử thanh toán
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div> 