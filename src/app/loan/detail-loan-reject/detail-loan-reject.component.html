<div class="container">
  <p-toast></p-toast>
  
  <div *ngIf="loading">
    <div class="socket">
      <div class="gel center-gel">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c1 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c2 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c3 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c4 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c5 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c6 r1">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c7 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c8 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c9 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c10 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c11 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c12 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c13 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c14 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c15 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c16 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c17 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c18 r2">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c19 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c20 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c21 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c22 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c23 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c24 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c25 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c26 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c28 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c29 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c30 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c31 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c32 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c33 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c34 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c35 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c36 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
      <div class="gel c37 r3">
        <div class="hex-brick h1"></div>
        <div class="hex-brick h2"></div>
        <div class="hex-brick h3"></div>
      </div>
    </div>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <div *ngIf="!loading && !error && loanDetail" class="loan-detail">
    <!-- Loan Status Card -->
    <p-card header="Trạng thái khoản vay" [style]="{'margin-bottom': '1rem'}">
      <div class="status-info">
        <p-tag severity="danger" [value]="loanDetail.status ?? undefined"></p-tag>
        <span class="date-info">Ngày tạo: {{ formatDate(loanDetail.createdAt) }}</span>
      </div>
    </p-card>

    <!-- Rejection Reasons Section -->
    <p-card *ngIf="loanDetail.rejectionReasons?.length" 
            header="Lý do từ chối" 
            [style]="{'margin-bottom': '1rem'}">
      <div class="rejection-reasons">
        <div *ngFor="let reason of loanDetail.rejectionReasons" class="rejection-reason">
          <p>{{ reason.reason }}</p>
          <small>Từ chối vào: {{ formatDate(reason.createdAt) }}</small>
        </div>
      </div>
    </p-card>

    <!-- Loan Details Card -->
    <p-card header="Chi tiết khoản vay" [style]="{'margin-bottom': '1rem'}">
      <form [formGroup]="loanForm" class="loan-form">
        <div class="form-field">
          <label for="amount">Số tiền vay (VND)</label>
          <p-inputNumber 
            id="amount" 
            formControlName="amount" 
            [min]="1000000"
            [showButtons]="true"
            mode="currency" 
            currency="VND" 
            locale="vi-VN">
          </p-inputNumber>
          <small *ngIf="loanForm.get('amount')?.errors?.['required'] && loanForm.get('amount')?.touched" class="error-text">
            Vui lòng nhập số tiền vay
          </small>
          <small *ngIf="loanForm.get('amount')?.errors?.['min'] && loanForm.get('amount')?.touched" class="error-text">
            Số tiền vay tối thiểu là 1.000.000 VND
          </small>
        </div>

        <div class="form-field">
          <label for="interestRate">Lãi suất (%)</label>
          <p-inputNumber 
            id="interestRate" 
            formControlName="interestRate" 
            [min]="0"
            [max]="100"
            [showButtons]="true"
            suffix="%">
          </p-inputNumber>
          <small *ngIf="loanForm.get('interestRate')?.errors?.['required'] && loanForm.get('interestRate')?.touched" class="error-text">
            Vui lòng nhập lãi suất
          </small>
          <small *ngIf="loanForm.get('interestRate')?.errors?.['min'] && loanForm.get('interestRate')?.touched" class="error-text">
            Lãi suất phải lớn hơn hoặc bằng 0%
          </small>
          <small *ngIf="loanForm.get('interestRate')?.errors?.['max'] && loanForm.get('interestRate')?.touched" class="error-text">
            Lãi suất không được vượt quá 100%
          </small>
        </div>

        <div class="form-field">
          <label for="termMonths">Kỳ hạn (tháng)</label>
          <p-inputNumber 
            id="termMonths" 
            formControlName="termMonths" 
            [min]="1"
            [showButtons]="true">
          </p-inputNumber>
          <small *ngIf="loanForm.get('termMonths')?.errors?.['required'] && loanForm.get('termMonths')?.touched" class="error-text">
            Vui lòng nhập kỳ hạn
          </small>
          <small *ngIf="loanForm.get('termMonths')?.errors?.['min'] && loanForm.get('termMonths')?.touched" class="error-text">
            Kỳ hạn tối thiểu là 1 tháng
          </small>
        </div>

        <div class="form-field">
          <label for="bankName">Ngân hàng chứng minh thu nhập</label>
          <p-dropdown
            id="bankName"
            formControlName="bankName"
            [options]="bankOptions"
            optionLabel="bankName"
            optionValue="bankName"
            placeholder="Chọn ngân hàng"
            [class.invalid]="loanForm.get('bankName')?.touched && loanForm.get('bankName')?.invalid">
          </p-dropdown>
          <small class="p-error" *ngIf="loanForm.get('bankName')?.touched && loanForm.get('bankName')?.hasError('required')">
            Vui lòng chọn ngân hàng.
          </small>
        </div>
        <div class="form-field">
          <label for="incomeAccountNumber">Số tài khoản ngân hàng chứng minh thu nhập</label>
          <input
            id="incomeAccountNumber"
            type="text"
            formControlName="incomeAccountNumber"
            placeholder="Nhập số tài khoản ngân hàng chứng minh thu nhập"
            [class.invalid]="loanForm.get('incomeAccountNumber')?.touched && loanForm.get('incomeAccountNumber')?.invalid"
            style="width: 100%" />
          <small class="p-error" *ngIf="loanForm.get('incomeAccountNumber')?.touched && loanForm.get('incomeAccountNumber')?.hasError('required')">
            Vui lòng nhập số tài khoản ngân hàng chứng minh thu nhập.
          </small>
        </div>
        <div class="form-field">
          <label for="declaredIncome">Thu nhập chứng minh (VND)</label>
          <p-inputNumber 
            id="declaredIncome" 
            formControlName="declaredIncome" 
            [min]="0"
            [showButtons]="true"
            mode="currency" 
            currency="VND" 
            locale="vi-VN">
          </p-inputNumber>
          <small *ngIf="loanForm.get('declaredIncome')?.errors?.['required'] && loanForm.get('declaredIncome')?.touched" class="error-text">
            Vui lòng nhập thu nhập chứng minh
          </small>
          <small *ngIf="loanForm.get('declaredIncome')?.errors?.['min'] && loanForm.get('declaredIncome')?.touched" class="error-text">
            Thu nhập phải lớn hơn hoặc bằng 0 VND
          </small>
        </div>
      </form>
    </p-card>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <p-button 
        label="Cập nhật và gửi lại" 
        icon="pi pi-check" 
        severity="success" 
        (onClick)="updateAndResubmitLoan()"
        [loading]="processingAction"
        [disabled]="!loanForm.valid">
      </p-button>
    </div>
  </div>
</div> 