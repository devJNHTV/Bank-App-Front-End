<div class="loan-container">
  <p-toast position="top-right"></p-toast>

  <ng-container *ngIf="loading; else mainContent">
    <div class="overlay">
      <p-progressSpinner strokeWidth="6"></p-progressSpinner>
    </div>
  </ng-container>

  <ng-template #mainContent>
    <div *ngIf="error" class="banner error">
      <i class="pi pi-exclamation-triangle"></i>
      <span>{{ error }}</span>
    </div>

    <div *ngIf="!error && loanDetail" class="grid-layout">
      <!-- LOAN & CUSTOMER CARDS -->
      <div class="cards-row">
        <p-card class="card modern" headerTemplate>
          <ng-template pTemplate="header">
            <div class="card-header">
              <i class="pi pi-money-bill card-icon"></i>
              <h3>Loan Details</h3>
            </div>
          </ng-template>
          <div class="info-grid">
            <div class="info-item">
              <i class="pi pi-id-card"></i>
              <div class="info-content">
                <label>Loan ID</label>
                <span>{{ loanDetail.loanId }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-credit-card"></i>
              <div class="info-content">
                <label>Account</label>
                <span>{{ loanDetail.accountNumber }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-calendar"></i>
              <div class="info-content">
                <label>Created</label>
                <span>{{ formatDate(loanDetail.createdAt) }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-dollar"></i>
              <div class="info-content">
                <label>Amount</label>
                <span>{{ formatCurrency(loanDetail.amount) }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-percentage"></i>
              <div class="info-content">
                <label>Rate</label>
                <span>{{ loanDetail.interestRate }}%</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-clock"></i>
              <div class="info-content">
                <label>Term</label>
                <span>{{ loanDetail.termMonths }} months</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-wallet"></i>
              <div class="info-content">
                <label>Income</label>
                <span>{{ formatCurrency(loanDetail.declaredIncome) }}</span>
              </div>
            </div>
          </div>
        </p-card>

        <p-card class="card modern" headerTemplate>
          <ng-template pTemplate="header">
            <div class="card-header">
              <i class="pi pi-user card-icon"></i>
              <h3>Customer Information</h3>
            </div>
          </ng-template>
          <div class="info-grid">
            <div class="info-item">
              <i class="pi pi-user"></i>
              <div class="info-content">
                <label>Name</label>
                <span>{{ customerInfo?.fullName }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-envelope"></i>
              <div class="info-content">
                <label>Email</label>
                <span>{{ customerInfo?.email }}</span>
              </div>
            </div>
            <div class="info-item">
              <i class="pi pi-phone"></i>
              <div class="info-content">
                <label>Phone</label>
                <span>{{ customerInfo?.phoneNumber }}</span>
              </div>
            </div>
          </div>
        </p-card>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="action-buttons" *ngIf="loanDetail.status === 'PENDING'">
        <p-button 
          label="Approve Loan" 
          icon="pi pi-check" 
          severity="success" 
          (onClick)="approveLoan()" 
          [loading]="processingAction">
        </p-button>
        <p-button 
          label="Reject Loan" 
          icon="pi pi-times" 
          severity="danger" 
          (onClick)="openRejectDialog()" 
          [loading]="processingAction">
        </p-button>
      </div>

      <!-- REJECT DIALOG -->
      <p-dialog 
        header="Reject Loan" 
        [(visible)]="showRejectDialog" 
        modal 
        [style]="{ width: '450px' }"
        [draggable]="false"
        [resizable]="false">
        <div class="dialog-content">
          <div class="form-group">
            <label for="reason">Reason for rejection:</label>
            <textarea 
              pInputTextarea 
              id="reason" 
              rows="4" 
              [formControl]="rejectionReasonControl" 
              placeholder="Enter reason..."
              class="w-full">
            </textarea>
          </div>
        </div>
        <ng-template pTemplate="footer">
          <p-button 
            label="Cancel" 
            icon="pi pi-times" 
            (onClick)="closeRejectDialog()"
            class="p-button-text">
          </p-button>
          <p-button 
            label="Reject" 
            icon="pi pi-check" 
            severity="danger" 
            (onClick)="rejectLoan()" 
            [loading]="processingAction">
          </p-button>
        </ng-template>
      </p-dialog>
    </div>
  </ng-template>
</div>
